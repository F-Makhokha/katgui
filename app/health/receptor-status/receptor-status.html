<div flex ng-controller="ReceptorStatusCtrl as vm" layout="column" layout-align="start"
     style="padding: 16px;" ng-class="{'connection-lost-bg':vm.connectionLost}">

    <div flex layout="column">
        <md-toolbar md-theme="{{themePrimary}}" layout="row" layout-align="start center"
                    class="md-whiteframe-z1">
            <span flex style="margin-left: 16px;" ng-show="!vm.sortBySubarrays">All Receptors</span>
            <span flex style="margin-left: 16px;" ng-show="vm.sortBySubarrays">Receptors by Subarray</span>
            <md-menu md-theme="{{themePrimaryButtons}}">
                <md-button class="md-icon-button inline-action-button" ng-click="$mdOpenMenu()"
                           style="margin-left: 0px; margin-right: 8px;">
                    <md-icon class="fa" md-font-icon="fa-ellipsis-v"></md-icon>
                </md-button>
                <md-menu-content width="4" style="padding-left: 16px;">
                    <md-menu-item>
                        <md-checkbox class="md-primary" ng-model="vm.sortBySubarrays" ng-click="">
                            Sort By Subarrays
                        </md-checkbox>
                    </md-menu-item>
                </md-menu-content>
            </md-menu>
        </md-toolbar>
        <div flex class="md-whiteframe-z1" style="padding: 16px;">

            <div layout="column" layout-align="start" ng-show="!vm.sortBySubarrays">
                <div class="md-whiteframe-z1">
                    <div layout="row">
                        <span class="receptor-status-row-span"></span>

                        <div ng-repeat="receptor in vm.receptorsData track by $index"
                             class="receptor-status-column-heading" layout="column" layout-align="center center"
                             ng-class="{'in-maintenance-item':receptor.in_maintenance}">
                            <span>{{receptor.name}}</span>
                        </div>
                    </div>
                    <div>
                        <div layout="row">
                            <div class="receptor-status-row-span" layout-align="start center" layout="row">
                                <span>Health - Device Status (AP)</span>
                            </div>
                            <div ng-repeat="receptor in vm.receptorsData track by $index"
                                 class="receptor-status-column-heading nominal-item"
                                 layout="column" layout-align="center center"
                                 ng-class="{'error-item':receptor.ap_device_status.value !== 'ok'}">
                                <span>{{receptor.ap_device_status.value}}</span>
                            </div>
                        </div>
                        <div layout="row">
                            <div class="receptor-status-row-span" layout-align="start center" layout="row">
                                <span>Mode</span>
                            </div>
                            <div ng-repeat="receptor in vm.receptorsData track by $index"
                                 class="receptor-status-column-heading nominal-item"
                                 layout="column" layout-align="center center"
                                 ng-class="{'stop-item': receptor.mode.value === 'STOP', 'stow-item': receptor.mode.value === 'STOW', 'error-item': receptor.windstow_active.value}">
                                <span ng-show="!receptor.windstow_active.value">{{receptor.mode.value}}</span>
                                <span ng-show="receptor.windstow_active.value">WINDSTOW</span>
                                <span style="width: 100%; text-align: center; border: 1px solid #333333;"
                                      class="inhibited-item" ng-show="receptor.inhibited.value">INHIBITED</span>
                        <span ng-show="receptor.lock.value" class="fa fa-asterisk on-target-span"
                              title="AP on Target"></span>
                            </div>
                        </div>
                        <div layout="row">
                            <div class="receptor-status-row-span" layout-align="start center" layout="row">
                                <span>Assigned/Allocated</span>
                            </div>
                            <div ng-repeat="receptor in vm.receptorsData track by $index"
                                 class="receptor-status-column-heading"
                                 layout="column" layout-align="center center"
                                 ng-class="{'in-maintenance-item':receptor.in_maintenance && !(receptor.assignedSubarray || receptor.allocatedSubarray), 'in-assigned-subarray-item': receptor.assignedSubarray, 'in-allocated-subarray-item': receptor.allocatedSubarray}">
                                <span ng-show="receptor.subarray" title="{{'Subarray ' + receptor.subarray}}">SA {{receptor.subarray}}</span>
                                <span ng-show="!receptor.subarray">Free</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div ng-repeat="(key, subarray) in vm.subarrays | orderBy:'id'" ng-if="vm.sortBySubarrays"
                 class="subarray-container md-whiteframe-z2" layout="row" layout-align="start"
                 style="min-width: 650px;" flex>
                <div layout="column" layout-align="start" flex>
                    <md-toolbar
                        md-theme="{{subarray.state === 'inactive'? 'grey' : subarray.state === 'active'? 'green' : subarray.state === 'error'? 'amber' : 'white'}}"
                        class="md-whiteframe-z1 md-hue-2"
                        layout="row" layout-align="center center"
                        style="max-height: 50px; min-height: 50px;">
                        <div flex style="position: relative">
                            <span ng-show="subarray.id === 'free'" style="position: absolute; left: 8px; top: -20px;">FREE</span>
                            <span ng-show="subarray.id !== 'free'" style="position: absolute; left: 8px; top: 8px;">SUBARRAY {{subarray.id}}</span>
                            <md-button ng-show="subarray.id !== 'free'" layout="row" style="min-height: 42px; width: calc(100% - 16px)"
                                       class="unselectable"
                                       ng-click="vm.navigateToSchedulerDetails(subarray.id)"
                                       title="Click to Manage Observations for Subarray {{subarray.id}}">
                                <span>{{subarray.state}}</span>
                                <span ng-if="subarray.maintenance">{{", in maintenance"}}</span>
                            </md-button>
                        </div>
                    </md-toolbar>

                    <div flex style="overflow: auto;" ng-class="{'maintenance-bg':subarray.maintenance}">
                        <div layout="row">
                            <span class="receptor-status-row-span"></span>

                            <div ng-repeat="receptor in vm.receptorsData | filter:{subarray:subarray.id} track by $index"
                                 class="receptor-status-column-heading" layout="column" layout-align="center center"
                                 ng-class="{'in-maintenance-item':receptor.in_maintenance}">
                                <span>{{receptor.name}}</span>
                            </div>
                        </div>
                        <div>
                            <div layout="row">
                                <div class="receptor-status-row-span" layout-align="start center" layout="row">
                                    <span>Health - Device Status (AP)</span>
                                </div>
                                <div ng-repeat="receptor in vm.receptorsData | filter:{subarray:subarray.id} track by $index"
                                     class="receptor-status-column-heading nominal-item"
                                     layout="column" layout-align="center center"
                                     ng-class="{'error-item':receptor.ap_device_status.value !== 'ok'}">
                                    <span>{{receptor.ap_device_status.value}}</span>
                                </div>
                            </div>
                            <div layout="row">
                                <div class="receptor-status-row-span" layout-align="start center" layout="row">
                                    <span>Mode</span>
                                </div>
                                <div ng-repeat="receptor in vm.receptorsData | filter:{subarray:subarray.id} track by $index"
                                     class="receptor-status-column-heading nominal-item"
                                     layout="column" layout-align="center center"
                                     ng-class="{'stop-item': receptor.mode.value === 'STOP', 'stow-item': receptor.mode.value === 'STOW', 'error-item': receptor.windstow_active.value}">
                                    <span ng-show="!receptor.windstow_active.value">{{receptor.mode.value}}</span>
                                    <span ng-show="receptor.windstow_active.value">WINDSTOW</span>
                                    <span style="width: 100%; text-align: center; border: 1px solid #333333;"
                                      class="inhibited-item" ng-show="receptor.inhibited.value">INHIBITED</span>
                                    <span ng-show="receptor.lock.value" class="fa fa-asterisk on-target-span"
                                        title="AP on Target"></span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="legend-popup" style="background: transparent; pointer-events: none;" layout="row"
             ng-init="transparentLegend = true"
             ng-class="{'transparent-legend':transparentLegend && !showLegend}">
            <md-button flex style="pointer-events: auto;" md-theme="{{themePrimaryButtons}}" ng-init="showLegend = false" ng-click="showLegend = !showLegend"
                       ng-mouseenter="transparentLegend = false" ng-mouseleave="transparentLegend = true" class="md-fab md-mini md-primary">
                <md-icon class="fa center-md-icon" ng-if="!showLegend" md-font-icon="fa-eye"></md-icon>
                <md-icon class="fa center-md-icon" ng-if="showLegend" md-font-icon="fa-eye-slash"></md-icon>
            </md-button>
            <div class="md-whiteframe-z3" layout="column" ng-show="showLegend"
                 style="background: white; padding: 8px;">
                <div layout="row" layout-align="start center">
                    <div class="color-patch nominal-child" title="Green"></div>
                    <span>Health - OK</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch unknown-child" title="Grey"></div>
                    <span>Mode - Stop</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch warn-child" title="Amber"></div>
                    <span>Mode - Inhibited</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch stow-item" title="Blue"></div>
                    <span>Mode - Stow</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch in-assigned-subarray-item" title="Light Green"></div>
                    <span>Assigned</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch in-allocated-subarray-item" title="Light Blue"></div>
                    <span>Allocated</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch in-maintenance-item" title="Purple"></div>
                    <span>In Maintenance</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch error-item" title="Red"></div>
                    <span>In Error</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch amber-item" title="Amber"></div>
                    <span>Subarray Active</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch in-maintenance-item" title="Purple"></div>
                    <span>Subarray In Maintenance</span></div>
                <div layout="row" layout-align="start center">
                    <div class="color-patch nominal-item" title="Green"></div>
                    <span>Subarray Inactive</span></div>
                <div layout="row" layout-align="start center">
                    <div style="border: 1px solid #d3d3d3" class="color-patch" title="White"></div>
                    <span>Nothing to Report</span></div>
            </div>
        </div>
    </div>
</div>
